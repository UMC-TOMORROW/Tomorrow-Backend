<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ì±„íŒ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>

<label>ì±„íŒ…ë°© ID: <input type="text" id="chatRoomId" value="1"></label><br/>
<label>ë©”ì‹œì§€ ë‚´ìš©: <input type="text" id="message" value="ì•ˆë…•í•˜ì„¸ìš”!"></label><br/>
<button onclick="connect()">ì—°ê²°</button>
<button onclick="sendMessage()">ë©”ì‹œì§€ ì „ì†¡</button>

<ul id="chat-log"></ul>

<script>
  let stompClient = null;

  function connect() {
    const socket = new SockJS("/wss");
    stompClient = Stomp.over(socket);
    stompClient.debug = null;

    const token = localStorage.getItem("accessToken"); // âœ… JWT í† í° êº¼ë‚´ì˜¤ê¸°

    stompClient.connect(
      { Authorization: "Bearer " + token }, // âœ… í—¤ë”ì— í¬í•¨
      function () {
        const chatRoomId = document.getElementById("chatRoomId").value;

        console.log("âœ… STOMP ì—°ê²° ì„±ê³µ");

        stompClient.subscribe("/sub/chats/" + chatRoomId, function (messageOutput) {
          const body = JSON.parse(messageOutput.body);
          console.log("ğŸ“© ë©”ì‹œì§€ ìˆ˜ì‹ :", body);

          const log = document.getElementById("chat-log");
          const li = document.createElement("li");
          li.innerText = `ğŸ“¨ ë©”ì‹œì§€ ID: ${body.messageId}`;
          log.appendChild(li);
        });

        alert("ì—°ê²° ì„±ê³µ!");
      },
      function (error) {
        console.error("âŒ STOMP ì—°ê²° ì‹¤íŒ¨:", error);
        alert("ì—°ê²° ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
      }
    );
  }


  function sendMessage() {
    if (!stompClient || !stompClient.connected) {
      alert("ë¨¼ì € ì—°ê²°ì„ í•´ì£¼ì„¸ìš”.");
      return;
    }

    const chatRoomId = document.getElementById("chatRoomId").value;
    const message = document.getElementById("message").value;

    if (!chatRoomId || !message) {
      alert("ì±„íŒ…ë°© IDì™€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const payload = {
      chattingRoomId: Number(chatRoomId),
      content: message,
      sentAt: new Date().toISOString()
    };

    console.log("ğŸš€ ë©”ì‹œì§€ ì „ì†¡:", payload);
    stompClient.send("/pub/chats/send", {}, JSON.stringify(payload));
  }
</script>
</body>
</html>
